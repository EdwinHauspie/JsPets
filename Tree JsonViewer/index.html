<!DOCTYPE html>
<html>
<head>
    <title>JsonViewer</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <link href="https://fonts.googleapis.com/css?family=Open%20Sans" rel="stylesheet">
    <link rel="stylesheet" href="./style.css"/>

    <script>
        let render = data => {
            var html = '<ul>',
                dpth = $('#depth')[0].valueAsNumber,
                sort = $('#sort').is(':checked');

            (function ___(o, name, depth) {
                if (depth >= dpth) return;

                name = name === null ? '' : (name + ': ');

                if (o === null) {
                    html += `<li>${name}<i>null</i></li>`;
                }
                else if (o instanceof Array) {
                    html += '<li>' + (o.length ? '<span class="toggle"></span>' : '') + name + `<i>[${o.length}]</i>`;
                    if (o.length) {
                        html += '<ul>';
                        for (var i = 0; i < o.length; i++) {
                            ___(o[i], i, depth + 1);
                        }
                        html += '</ul>';
                    }
                    html+='</li>';
                }
                else if (typeof o == 'object') {
                    var props = Object.keys(o);
                    html += '<li>' + (props.length ? '<span class="toggle"></span>' : '') + `${name}<i>{${props.length}}</i>`;
                    if (props.length) {
                        html += '<ul>';
                        if (sort) props = props.sort((a, b) => a.localeCompare(b));
                        for (var i = 0; i < props.length; i++) {
                            ___(o[props[i]], props[i], depth + 1);
                        }
                        html += '</ul>';
                    }
                    html += '</li>';
                }
                else {
                    html += `<li>${name}<span>` + (typeof o === 'string' ? ('"' + o.replace(/\</g, '&lt;') + '"') : o) + '</span></li>';
                }
            })(data, null, 0);

            html += '</ul>';

            $('.tree').hide().html(html).fadeIn();
            $('.tree > ul > li').addClass('open');

            //Prularia
            /*var items = $('.tree > ul > li > ul > li').hide();
            var counter = 0;
            var c = setInterval(function() {
                $(items[counter++]).fadeIn('fast');
                if (counter == items.length) clearInterval(c);
            }, 300 / items.length);*/
        }

        $(() => {
            $('.tree').on('click', '.toggle', e => { e.stopPropagation(); $(e.target).closest('li').toggleClass('open'); return false; });

            $('#parse').click(e => {
                try {
                    $('.tree').empty();
                    render(JSON.parse($('textarea').val()));
                } catch(e) {
                    alert('Invalid JSON.');
                }
            });

            $('#get').click(e => {
                $('.tree').empty();
                let url = $('#url').val();
                localStorage.setItem('url', url);
                $.getJSON('/getjson?url=' + encodeURIComponent(url)).then(r => render(r)).fail(r => alert('Error.'));
            });

            $('#depth').on('change mousemove', e => {
                $(e.target).parent().find('span').text(e.target.valueAsNumber);
            });

             $('#url').val(localStorage.getItem('url'));
        });
    </script>
</head>

<body>
    <div class="actions">
        <button onclick="$('.tree').find('li').addClass('open');">Expand all</button>
        <button onclick="$('.tree').find('li').removeClass('open').first().addClass('open');">Collapse all</button>
        <label><input type="range" id="depth" min="2" max="9" value="9"> Render depth <span>9</span></label>
        <label><input type="checkbox" id="sort" checked="checked">Sort properties</label>
        <button id="get">Get</button>
        <input type="text" id="url">
        <button id="parse">Parse</button>
        <textarea spellcheck="false" autocomplete="off">{ "firstName": "John", "lastName": "Smith", "age": 25 }</textarea>
    </div>

    <div class="tree"><i>No data yet</i></div>
</body>

</html>